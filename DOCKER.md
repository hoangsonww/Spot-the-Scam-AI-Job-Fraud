# Docker Usage Guide

This guide covers local container workflows, GitHub Actions automation, and publishing Spot the Scam images to GitHub Container Registry (GHCR).

---

## 1. Available Images

| Image | Description | Default tag scheme |
|-------|-------------|--------------------|
| `spot-the-scam-model` | Packaged training artifacts (classical winner, reports, MLflow run) | `latest`, `<git-sha>` |
| `spot-the-scam-api` | FastAPI inference + insights service | `latest`, `<git-sha>` |
| `spot-the-scam-frontend` | Next.js dashboard | `latest`, `<git-sha>` |

When published to GHCR the fully qualified names become:

```
ghcr.io/<OWNER>/spot-the-scam-api:<TAG>
ghcr.io/<OWNER>/spot-the-scam-frontend:<TAG>
```

Replace `<OWNER>` with your GitHub username or organization.

---

## 2. Local Development

### 2.1 Build images

```bash
# API (FastAPI + ONNX/MLflow stack)
docker build -t spot-the-scam-api:latest .

# Frontend (Next.js/Node)
docker build -t spot-the-scam-frontend:latest -f frontend/Dockerfile frontend
```

### 2.2 Compose workflow

```bash
docker compose up --build
```

The compose stack exposes:

- API at <http://localhost:8000>
- Frontend at <http://localhost:3000>

Mounted volumes persist artifacts, experiments, MLflow runs, and configs. Override CORS or other runtime behaviours through environment variables in `docker-compose.yml` (e.g., `SPOT_SCAM_ALLOWED_ORIGINS`).

### 2.3 Running pipeline tasks inside the API container

```bash
docker compose exec api bash
PYTHONPATH=src python -m spot_scam.pipeline.train --skip-transformer
```

---

## 3. Publishing Manually to GHCR

1. Create a GitHub personal access token with `write:packages` scope (or reuse the built-in `GITHUB_TOKEN` on GitHub Actions).
2. Authenticate:

   ```bash
   echo "${GHCR_TOKEN}" | docker login ghcr.io -u <OWNER> --password-stdin
   ```

3. Tag and push:

   ```bash
   docker tag spot-the-scam-api:latest ghcr.io/<OWNER>/spot-the-scam-api:latest
   docker push ghcr.io/<OWNER>/spot-the-scam-api:latest

   docker tag spot-the-scam-frontend:latest ghcr.io/<OWNER>/spot-the-scam-frontend:latest
   docker push ghcr.io/<OWNER>/spot-the-scam-frontend:latest

   docker tag spot-the-scam-model:latest ghcr.io/<OWNER>/spot-the-scam-model:latest
   docker push ghcr.io/<OWNER>/spot-the-scam-model:latest
   ```

---

## 4. GitHub Actions Automation

The workflow at `.github/workflows/docker-publish.yml` now performs four stages on every push/PR:

- **Train classical model artifacts:** installs Python 3.12, runs `python -m spot_scam.pipeline.train --skip-transformer`, and uploads the resulting `artifacts/`, `experiments/`, and `mlruns/` directories so you can download them from the run summary.
- **Build model container:** packages those artifacts into `spot-the-scam-model` and publishes to GHCR.
- **Build API container:** uses Docker Buildx to build/push `spot-the-scam-api`.
- **Build frontend container:** uses Docker Buildx to build/push `spot-the-scam-frontend`.

Additional workflow behaviour:

- **Trigger:** all pushes and pull requests targeting `master`/`main`.
- **Pull requests:** build the images (no push) with `docker buildx` to catch regressions.
- **Pushes:** log in to GHCR with `GITHUB_TOKEN` and push tags generated by `docker/metadata-action`.
  - `latest` (default branch pushes)
  - `sha-<short-commit>`
  - `pr-<number>` (PR context)
- Cache is managed via `type=gha` to speed up rebuilds.

No additional secrets are required—GitHub automatically grants the workflow a scoped token with `packages: write`.

To inspect runs or re-trigger builds, visit the **Actions → “Build & Publish Containers”** page in the GitHub UI.

---

## 5. Pulling Images

```bash
docker pull ghcr.io/<OWNER>/spot-the-scam-model:latest
docker pull ghcr.io/<OWNER>/spot-the-scam-api:latest
docker pull ghcr.io/<OWNER>/spot-the-scam-frontend:latest
```

Run the API image standalone:

```bash
docker run --rm -p 8000:8000 ghcr.io/<OWNER>/spot-the-scam-api:latest
```

Inspect the model artifact bundle:

```bash
docker run --rm -it ghcr.io/<OWNER>/spot-the-scam-model:latest bash
# artifacts are available under /app/artifacts, MLflow runs under /app/mlruns
```

Front the API with the dashboard:

```bash
docker network create spot-the-scam
docker run -d --name scam-api --network spot-the-scam -p 8000:8000 ghcr.io/<OWNER>/spot-the-scam-api:latest
docker run -d --name scam-ui --network spot-the-scam -p 3000:3000 \
  -e NEXT_PUBLIC_API_BASE_URL=http://scam-api:8000 \
  ghcr.io/<OWNER>/spot-the-scam-frontend:latest
```

---

## 6. Storage & Troubleshooting Tips

- Docker Desktop (especially on WSL2) stores layers on the system drive—keep several GB free before building.
- Remove old layers with `docker system prune` when you no longer need cached images.
- Double-check that `docker compose` uses the project root as context to include all dependencies.
- If builds fail on CI, inspect the cached artifacts in the workflow run logs for clues.

---

That’s it! With the local commands and GitHub workflow working together, you can develop, test, and publish Spot the Scam containers reliably. Happy shipping!
